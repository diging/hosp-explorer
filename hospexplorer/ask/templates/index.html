{% extends "_base.html" %}
{% load static %}

{% block content %}
    <link rel="stylesheet" href="{% static 'css/ask.css' %}">
    <div
        x-data="{
            userQuery: '',
            messages: [], // in-memory only; resets on page refresh (not persisted to localStorage, session, or DB)
            isLoading: false,
            showScrollBtn: false,

            async getAnswer() {
                if (!this.userQuery.trim()) return;

                const question = this.userQuery.trim();
                this.userQuery = '';

                this.messages.push({ role: 'user', content: question });
                this.$nextTick(() => this.scrollToBottom());

                this.isLoading = true;
                try {
                    const response = await fetch('{% url 'ask:query-llm' %}?query=' + encodeURIComponent(question));
                    const data = await response.json();
                    if (!response.ok || data.error) {
                        this.messages.push({ role: 'assistant', content: 'Something went wrong. Please try again.' });
                    } else {
                        this.messages.push({ role: 'assistant', content: data.message });
                    }
                } catch (error) {
                    this.messages.push({ role: 'assistant', content: 'Something went wrong. Please try again.' });
                }
                this.isLoading = false;
                this.$nextTick(() => this.scrollToBottom());
            },

            // Smoothly scrolls chat to the latest message
            scrollToBottom() {
                const c = this.$refs.chatContainer;
                if (c) c.scrollTop = c.scrollHeight;
            },

            // Shows the scroll-down button when user has scrolled more than 150px from bottom
            checkScroll() {
                const c = this.$refs.chatContainer;
                if (!c) return;
                this.showScrollBtn = (c.scrollHeight - c.scrollTop - c.clientHeight) > 150;
            }
        }"
        class="chat-wrapper"
    >
        <!-- Chat header -->
        <div class="chat-header">
            <h3 class="mb-0 mt-3">Hopper</h3>
        </div>

        <!-- Chat area -->
        <div class="chat-container" x-ref="chatContainer" @scroll="checkScroll()">

            <!-- Welcome state -->
            <div x-show="messages.length === 0" class="chat-welcome">
                <div class="chat-welcome-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M5 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm4 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                        <path d="m2.165 15.803.02-.004c1.83-.363 2.948-.842 3.468-1.105A9.06 9.06 0 0 0 8 15c4.418 0 8-3.134 8-7s-3.582-7-8-7-8 3.134-8 7c0 1.76.743 3.37 1.97 4.6a10.437 10.437 0 0 1-.524 2.318l-.003.011a10.722 10.722 0 0 1-.244.637c-.079.186.074.394.272.362a21.673 21.673 0 0 0 .693-.125zm.8-3.108a1 1 0 0 0-.287-.801C1.618 10.83 1 9.468 1 8c0-3.192 3.004-6 7-6s7 2.808 7 6c0 3.192-3.004 6-7 6a8.06 8.06 0 0 1-2.088-.272 1 1 0 0 0-.711.074c-.387.196-1.24.57-2.634.893a10.97 10.97 0 0 0 .398-2z"/>
                    </svg>
                </div>
                <h4>How can I help you today?</h4>
                <p class="text-muted">Ask me anything about hospital data.</p>
            </div>

            <!-- Message list -->
            <template x-for="(msg, index) in messages" :key="index">
                <div :class="'chat-message chat-message-' + msg.role">
                    <div class="chat-avatar" x-text="msg.role === 'user' ? 'You' : 'AI'"></div>
                    <div class="chat-bubble"
                         :class="'chat-bubble-' + msg.role"
                         x-html="msg.role === 'assistant' ? marked.parse(msg.content) : msg.content">
                    </div>
                </div>
            </template>

            <!-- Loading indicator -->
            <div x-show="isLoading" class="chat-message chat-message-assistant">
                <div class="chat-avatar">AI</div>
                <div class="chat-bubble chat-bubble-assistant">
                    <span class="thinking-dots">Thinking</span>
                </div>
            </div>
        </div>

        <!-- Scroll to bottom button -->
        <button
            x-show="showScrollBtn"
            x-transition
            class="scroll-down-btn"
            @click="scrollToBottom()"
        >
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                <path fill-rule="evenodd" d="M8 1a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L7.5 13.293V1.5A.5.5 0 0 1 8 1z"/>
            </svg>
        </button>

        <!-- Input bar -->
        <div class="chat-input-bar">
            <div class="chat-input-wrapper">
                <input
                    type="text"
                    class="chat-input"
                    placeholder="Ask me something..."
                    x-model="userQuery"
                    @keyup.enter="getAnswer()"
                    :disabled="isLoading"
                >
                <button
                    class="chat-send-btn"
                    @click="getAnswer()"
                    :disabled="isLoading || !userQuery.trim()"
                >
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M15.854.146a.5.5 0 0 1 .11.54l-5.819 14.547a.75.75 0 0 1-1.329.124l-3.178-4.995L.643 7.184a.75.75 0 0 1 .124-1.33L15.314.037a.5.5 0 0 1 .54.11ZM6.636 10.07l2.761 4.338L14.13 2.576 6.636 10.07Zm6.787-8.201L1.591 6.602l4.339 2.76 7.494-7.493Z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
{% endblock %}
